---
title: "Модуль upmeter"
---

Модуль собирает статистику по типам доступности для компонентов кластера и Deckhouse. Позволяет оценивать степень выполнения SLA на эти компоненты, показывает данные о доступности в web-интерфейсе и предоставляет web-страницу статуса работы компонентов кластера.

С помощью Custom Resource [UpmeterRemoteWrite](cr.html#upmeterremotewrite) можно экспортировать метрики доступности по протоколу [Prometheus Remote Write](https://docs.sysdig.com/en/docs/installation/prometheus-remote-write/).

Состав модуля:
- **agent** — делает пробы доступности и отправляет результаты на сервер, работает на мастер-узлах.
- **upmeter** — агрегатор результатов и API-сервер для их извлечения.
- **front**
  - **status** — показывает текущий уровень доступности за последние 10 минут (по умолчанию требует авторизации, но её можно отключить).
  - **webui** — дашборд со статистикой по пробам и группам доступности (требует авторизации).
- **smoke-mini** — постоянное *smoke-тестирование* с помощью StatefulSet, похожего на настоящее приложение.

Модуль отправляет около 100 показаний метрик каждые 5 минут. Это значение зависит от количества включенных модулей Deckhouse.

## Интерфейс

Пример web-интерфейса:
![Пример web-интерфейса](../../images/500-upmeter/image1.png)

Пример графиков по метрикам из upmeter в Grafana:
![Пример графиков по метрикам из upmeter в Grafana](../../images/500-upmeter/image2.png)


## Измерение доступности и сравнение с SLA

### Концепция

Агенты апметра ds/upmeter-agent собирают данные, запуская пробы. Дальше раз в 30 секунд они отправляют на сервер sts/upmeter статистику по пробам.


#### Термины

**Проверка** (check) — это единица получения данных из кластера.

**Проба** (probe) — это единица сбора статистики доступности фичи. Проба может состоять из нескольких проверок.


**Группа доступности** (availablility group, group) — это группа проб объединенная по принципу функциональности. Группа состоит из одной или более проб.  По группе оценивается доступность и соблюдение SLA согласно условиям соглашения.

Если за интервал измерения в пробе не прошла хотя бы одна проверка, то проба не прошла.

Если за интервал хотя бы одна проба в группе не прошла, то и группа «не прошла» в это время.

Статусы проверок → статусы проб → статусы групп:

* **Up** — проверка доступности положительная
* **Down** — проверка доступности отрицательная
* **Unknown** — данные собирались, но не смогли вынести вердикт доступности
* **Nodata** — данные не собирались, например если upmeter-agent не работал

Пример для статуса *unknown*. Перед проверкой статуса пода (Ready или нет), делается проверка доступности аписервера — запрос на /version, как в пробе control-plane/apiserver. Если версию аписервера получить не удалось, проверка пода возвращает статус Unknown, потому что статус пода узнать невозможно.


Агенты апметра отправляют статистику доступности за 30 секунд на сервер. Севрер комбинирует статистику по принципу самой удачной в интервал 5 минут. 5 минут — это интервал хранения данных и отправки метрик.

### Метрики

Апметр отправляет данные по протоколу rewmote_write. Так как он копит статистику доступности за 5 минут, то и экспортирует это значение раз в 5 минут. Поэтому в метриках такой интервал между сэмплами.

Метрика называется *status_time* — это время одного статуса за период 5 минут.  Статусы в метриках есть для индивидуальных проб и для групп целиком.

Пример метрик для пробы и группы целиком:

```promql
# Пример для группы
status_time{group="synthectic", probe="dns", status="up"}        4990000

# Пример для пробы
status_time{group="synthectic", probe="__total__", status="up"}  4990000
```



Пример. Возьмем для простоты только статусы *up* и *down*. В пяти минутах 300000 миллисекунд, в этих единицах приходит значение. Сумма статусов — всегда пять минут. Допустим, в точке метрики пришли значения с лейблами

    100000 status=down
    200000 status=up
Тогда

    availability = up/(down+up) = ⅔ = 66%

— это доступность группы или пробы за 5 минут.


Апметр оценивает время не-простоя с использоваением статуса *unknown*: делит время «не простоя» на все измеренное время.

    availability = (up+unknown)/(down+up+unknown)


### Что измеряет апметр: группы и пробы


#### Группа доступности control-plane

##### apiserver
запрос на /version
раз в 5 секунд

##### basic-functionality
создать cm, удалить cm, проверить что получилось
раз в 5 секунд

##### namespace
создать ns, удалить ns, проверить что получилось
раз в 1 минуту

##### controller-manager
Создать StatefulSet, проверить что создался pod (он не шедулится, его состояние нам не важно)
раз в 1 минуту

##### scheduler
создать под, проверить что он куда-то зашедулится
раз в 1 минуту

#### Группа доступности deckhouse

Одна проба

##### cluster-configuration

Апметр перезаписывает одно поле в CR, а хук в декхаусе дублирует его же в другое поле в этой же CR, тогда апметр делает вывод, что конфигурация кластера, то есть Декхаус, в рабочем состоянии
Период: 1 минута
Проверяет доступность Control Plane
Таймаут 5с
Если недоступен, то проба переходит в Unknown
Проверяет, что состояние пода декхауса — Ready
Таймаут 5с
Если Running, но не Ready
под запущен до 20 минут, то проба переходит в Unknown
под запущен более 20 минут, то проба переходит в Down
Если Terminating, то проверка переходит в состояние Unknown
Если не Running, то проверка переходит в состояние Down
Пишет в CR
Таймаут 5 сек
Если CR нет, то агент его создает
Поле spec.initial (int) случайное значение
Ждет изменения в CR
Таймаут 30с
Поле spec.mirror (int) должно быть переопределено хуком Декхауса. Хук берет значение из spec.initial и записывает в spec.mirror.
Проба ждет, когда поле spec.mirror станет равным spec.initial
Группа доступности extensions
cluster-autoscaler
cluster-autoscaler (хотя бы 1 pod Ready)
Период 10с
cluster-scaling
bashible-apiserver (хотя бы 1 pod Ready)
Период 10с
Таймаут 5с
mcm (хотя бы 1 pod Ready)
Период 10с
Таймаут 5с
ccm (хотя бы 1 pod Ready)
Период 10с
Таймаут 5с
grafana
pod (хотя бы 1 pod Ready)
Период 10с
openvpn
pod (хотя бы 1 pod Ready)
Период 10с
prometheus-longterm
pod (хотя бы 1 pod Ready)
Период 10с
Api, через сервис запрос /api/v1/query?query=vector(1) вернул нам 1
Период 10с
dashboard
pod (хотя бы 1 pod Ready)
Период 10с
dex
pod (хотя бы 1 pod Ready)
Период 10с
keys (запрос /keys)
Период 10с

#### Группа доступности load-balancing
load-balancer-configuration
ccm запущен (хотя бы 1 pod Ready)
Период 10с
metallb
metallb controller (хотя бы 1 pod Ready)
Период 10с
Таймаут 5с
metallb speaker (хотя бы 1 pod Ready)
Период 10с
Таймаут 5с

#### Группа доступности monitoring-and-autoscaling
prometheus
Pod, запущен prometheus (хотя бы 1 pod Ready).
раз в 10 секунд
api, через сервис запрос /api/v1/query?query=vector(1) вернул нам 1
раз в 10 секунд
trickster
Pod (хотя бы 1 pod Ready)
раз в 10 секунд
Api
(проверяем что через сервис запрос /trickster/main/api/v1/query?query=vector(1) вернул нам 1)
раз в 10 секунд
prometheus-metrics-adapter
Pod, запущен prometheus-metrics-adapter (хотя бы 1 pod Ready).
раз в 5 секунд
api отдает метрики (/apis/custom.metrics.k8s.io/v1beta1/namespaces/d8-upmeter/metrics/memory_1m вернул нам не нулевое значение)
раз в 5 секунд
vertical-pod-autoscaler
vpa-updater (хотя бы 1 pod Ready).
раз в 10 секунд
vpa-recommender (хотя бы 1 pod Ready).
раз в 10 секунд
vpa-admission-controller (хотя бы 1 pod Ready)
раз в 10 секунд
metric-sources
Node-exporter (all desired pods are ready)
на всех нодах, где должны быть поды, они есть и они все в состоянии Ready
Не учитываются ноды
которым меньше 10 минут
которые в процессе удаления (deletionTimestamp)
Закордоненные
раз в 10 секунд
kube-state-metrics (хотя бы 1 pod Ready)
раз в 10 секунд
key-metrics-present
в prometheus есть метрики от kube-state-metrics
раз в 15 секунд
в prometheus есть метрики от node-exporter
раз в 15 секунд
в prometheus есть метрики от kubelet
раз в 15 секунд
Horizontal-pod-autoscaler (вычисляемая проба)
прошли все проверки для проб
monitoring-and-autoscaling/prometheus-metrics-adapter
control-plane/controller-manager

#### Группа доступности Nginx
Пробы создаются динамически для имеющихся контроллеров

[имя контролллера]
Pod ready
Раз в 5 секунд

#### Группа доступности Node Groups
Пробы создаются динамически для нод-групп, у которых NG.spec.CloudInstances.minPerZone > 0

[имя группы узлов]
Количество узлов в нод-группе соответствует ожидаемому в каждой зоне
Раз в 10 секунд

#### Группа доступности Synthetic
Проверяет сетевую связность с помощью маленького модельного сервера «smoke-mini». Каждый из пяти подов smoke-mini раз в пять минут меняет ноду. Поды разнесены по зонам доступности. Задача — проверить сетевую доступность между парами нод, покрывая все пары со временем в случайном порядке.

access
хотя бы один pod smoke-mini, который отвечает 200кой. Список pod’ов берется из DNS.
раз в 5 секунд
dns
smoke, хотя бы один pod smoke-mini отвечает 200кой на /dns. Он резолвит “kubernetes.default”
раз в 200 миллисекунд
Internal, upmeter-agent резолвит внутренний домен kubernetes.default.svc.<<global.discovery.clusterDomain>>
раз в 200 миллисекунд
neighbour
хотя бы один pod smoke-mini отвечает 200кой на /neighbor.
Список pod’ов берется из DNS.
smoke-mini опрашивает соседние поды по имени Headless сервиса
раз в 5 секунд
neighbour-via-service
хотя бы один pod smoke-mini отвечает 200кой на /neighbour-via-service
Список pod’ов берется из DNS.
Smoke-mini делает 4 запроса на общий сервис ClusterIP и отвечает 200, если было не больше 2 ошибок
раз в 5 секунд
