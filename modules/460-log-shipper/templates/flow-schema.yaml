# FlowSchema and API access limitation is required because log-shipper pods can simultaneously make
# lots of cluster-scoped list requests. These requests become preflight in clusters with many pods and hit etcd.
# It leads to the growth of memory consumed by both etcd and kube-apiserver and can cause OOMKills.
---
{{- include "helm_lib_flow_schema_apiversion" (list .) }}
kind: FlowSchema
metadata:
  name: {{ .Chart.Name }}-flowschema
  {{- include "helm_lib_module_labels" (list .) | nindent 2 }}
spec:
  priorityLevelConfiguration:
    name: cluster-low
  distinguisherMethod:
    type: ByUser
  rules:
  - resourceRules:
    - apiGroups: [""]
      clusterScope: true
      namespaces: ["*"]
      resources: ["pods"]
      verbs: ["list", "get"]
    subjects:
    - kind: ServiceAccount
      serviceAccount:
        name: log-shipper
        namespace: d8-{{ .Chart.Name }}
