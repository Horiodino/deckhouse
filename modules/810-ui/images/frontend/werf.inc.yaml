image: {{ .ModuleName }}/{{ .ImageName }}
from: {{ .Images.BASE_NGINX_ALPINE }}
docker:
  # WORKDIR: /app
  EXPOSE: '8080'
  # USER: app
git:
- add: /modules/810-ui/images/frontend/nginx.conf
  to: /etc/nginx/nginx.conf
import:
- artifact: {{ $.ModuleName }}/{{ $.ImageName }}-assets-{{ $image_version }}
  add: /app/dist
  after: install

---
artifact: {{ .ModuleName }}/{{ .ImageName }}-assets-{{ $image_version }}
from: {{ .Images.BASE_NODE_16_ALPINE }}
git:
- add: /modules/810-ui/images/frontend
  to: /app
  # owner: app
  # group: app
  excludePaths:
  - public/mockServiceWorker.js
  - vendor
  - node_modules
  - nginx.conf
  stageDependencies:
    install:
    - package-lock.json
    setup:
    - src/*
ansible:
  install:
  - name: 'Install dependencies'
    shell: |
      set -e
      cd /app
      npm ci --ignore-scripts
    args:
      executable: /bin/bash
  setup:
  - name: "Build assets"
    shell: |
      set -e
      export NODE_ENV=production
      cd /app

      npm run build-only
    args:
      executable: /bin/bash
